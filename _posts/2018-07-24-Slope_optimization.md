---
layout:     post
title:      "斜率优化学习笔记"
date:       2018-07-24 12:00:00
author:     "Ufowoqqqo"
header-img: "img/solution_bg.png"
mathjax:    true
catalog:    true
tags:
    - 算法笔记
    - 斜率优化
---



考虑形如 $f[i]=\max\{f[j] + g[i]\times x[j] + t[j] + h[i]\}$ 的状态转移方程。

注意到其中 $h[i]$ 与决策无关，先提出来。
$$
f[i]=h[i] + \max\{f[j]+g[i]\times x[j]+t[j]\}
$$
斜率优化用于对上述形式转移方程的决策优化。

所谓决策优化，其实就是及时排除冗余状态，例如最简单的单调队列优化，就是排除了在选取范围外或在范围内但不可能最优的状态。但单调队列只能优化决策的价值只与其自身有关的情况，而对于决策的价值与其自身及当前状态都有关的情况，则需要斜率优化。本质上仍然是决策单调性的思想。

---

考虑在 $i$ 之前的 $2$ 个决策 $j_1$ 和 $j_2$。不妨设 $j_1<j_2$，考虑什么情况下 $j_2$ 肯定优于 $j_1$，以及时排除 $j_1$。
$$
f[j_1] + g[i] \times x[j_1] + t[j_1] \le f[j_2] + g[i] \times x[j_2] + t[j_2]
$$
移项，合并同类项。
$$
g[i]\times(x[j_1]-x[j_2])\le -(f[j_1]+t[j_1])+f[j_2]+t[j_2]
$$
令 $y(j)=-(f[j] + t[j])$，则
$$
g[i]\times (x[j_1]-x[j_2])\le y(j_1)-y(j_2)
$$
根据 $x$ 的单调性进行分类讨论。

以 $x$ 单调递增为例，则 $x[j_1]-x[j_2]<0$，移项并变号。
$$
g[i]\ge \frac{y(j_1)-y(j_2)}{x[j_1]-x[j_2]}
$$

如果把 $x, y$ 分别视为坐标系上的 $1$ 维，$1$ 个决策就对应了平面上的 $1$ 个点，上式不等号右边对应的就是相邻决策点 $j_1, j_2$ 的连线段的斜率。

考虑相邻的 $3$ 个决策 $j_1, j_2, j_3$，记 $k(j_1, j_2)$ 为决策点 $j_1, j_2$ 连线段的斜率。

那么如果 $k(j_1, j_2)\ge k(j_2, j_3)$，就可以及时排除决策 $j_2$。

这是因为如果 $g[i]\ge k(j_1, j_2)$，必然也有 $g[i]\ge k(j_2, j_3)$，即如果 $j_2$ 优于 $j_1$，$j_3$ 必然优于 $j_2$。这样就只会出现 $2$ 种情况，$j_1$ 优于 $j_2$ 或 $j_3$ 优于 $j_2$。换言之， $j_2$ 无论如何都不会是最优决策。

反之如果 $k(j_1, j_2) < k(j_2, j_3)$，如果 $g[i]\ge k(j_1, j_2)$ 时不 $1$ 定有 $g[i]\ge k(j_2, j_3)$，即当 $j_2$ 优于 $j_1$ 时 $j_3$ 未必优于 $j_3$，因此此时不能排除任何决策。

可以发现我们要保留的决策点满足相邻点连线段的斜率递增，画出来就是下凸壳的形式。

---

维护可以用队列实现，队中元素是 $i$ 以前的决策点。

对于每个状态 $i$，先考虑队首及其后决策点连线的斜率，若不大于 $g[i]$ 则将队首不断出队，直至斜率不小于 $g[i]$ 或队中仅剩 $1$ 个元素为止。此时的队首就是状态 $i$ 能取到的最优的决策 $j$。

计算完 $f[i]$ 后再将点 $i$ 尝试加入队尾。记原队尾元素为 $r$，其前 $1$ 个元素为 $r-1$，则若 $k(r-1, r)\ge k(r, i)$，即将 $i$ 加入后会破坏凸壳的单调性，则不断将队尾出队，直至不会破坏单调性或队中仅剩 $1$ 个元素为止。

将 $i$ 入队。

总的时间复杂度为 $O(n)$。